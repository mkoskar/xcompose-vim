#!/usr/bin/env python

import re
import time

keymap = {
    0x0020: 'space',
    0x0021: 'exclam',
    0x0022: 'quotedbl',
    0x0023: 'numbersign',
    0x0024: 'dollar',
    0x0025: 'percent',
    0x0026: 'ampersand',
    0x0027: 'apostrophe',
    0x0028: 'parenleft',
    0x0029: 'parenright',
    0x002A: 'asterisk',
    0x002B: 'plus',
    0x002C: 'comma',
    0x002D: 'minus',
    0x002E: 'period',
    0x002F: 'slash',
    0x003A: 'colon',
    0x003B: 'semicolon',
    0x003C: 'less',
    0x003D: 'equal',
    0x003E: 'greater',
    0x003F: 'question',
    0x0040: 'at',
    0x005B: 'bracketleft',
    0x005C: 'backslash',
    0x005D: 'bracketright',
    0x005E: 'asciicircum',
    0x005F: 'underscore',
    0x0060: 'grave',
    0x007B: 'braceleft',
    0x007C: 'bar',
    0x007D: 'braceright',
    0x007E: 'asciitilde',
}


def key(c):
    if c == r'\\' or c == r'\'':
        c = c[1]
    return keymap.get(ord(c), c)


unimap = {}
with open('UnicodeData.txt', 'r') as f:
    for line in f:
        if not line:
            continue
        line = line.strip()
        v = tuple(line.split(';'))
        k = int(v[0], 16)
        unimap[k] = v

timestamp = time.strftime('%Y-%m-%d %H:%M:%S %z')

header = f'''\
# vim: ft=xcompose

# XCompose digraphs as defined by Vim
#
# Generated by:
#
#   https://github.com/mkoskar/xcompose-vim
#   > {timestamp}
#
# See also:
#
#   (vim/nvim) :help digraphs
#   Compose(5)
#   RFC1345 (Character Mnemonics and Character Sets)

# The second character has a standard meaning:
#
#   Char name               Char    Meaning
#   ---------               ----    -------
#   Exclamation mark        !       Grave
#   Apostrophe              '       Acute accent
#   Greater-Than sign       >       Circumflex accent
#   Question mark           ?       Tilde
#   Hyphen-Minus            -       Macron
#   Left parenthesis        (       Breve
#   Full stop               .       Dot above
#   Colon                   :       Diaeresis
#   Comma                   ,       Cedilla
#   Underline               _       Underline
#   Solidus                 /       Stroke
#   Quotation mark          "       Double acute accent
#   Semicolon               ;       Ogonek
#   Less-Than sign          <       Caron
#   Zero                    0       Ring above
#   Two                     2       Hook
#   Nine                    9       Horn
#
#   Equals                  =       Cyrillic (= used as second char)
#   Asterisk                *       Greek
#   Percent sign            %       Greek/Cyrillic special
#   Plus                    +       smalls: Arabic, capitals: Hebrew
#   Three                   3       some Latin/Greek/Cyrillic letters
#   Four                    4       Bopomofo
#   Five                    5       Hiragana
#   Six                     6       Katakana

'''

digraphs = set()
with open('digraph.c', 'r') as f, \
     open('.XCompose-vim', 'w') as of:
    of.write(header)
    started = False
    for line in f:
        if not line:
            continue
        line = line.strip()
        if not started:
            if re.search(r'digraphs for Unicode from RFC1345', line):
                started = True
        else:
            if re.fullmatch(r'\};', line):
                break
            if m := re.search(r'define DG_START_(\w*)', line):
                of.write(f'\n# {m.group(1)}\n')
                continue
            if m := re.search(r"\{\s*'(.*)',\s*'(.*)',\s*(.+)\s*\}", line):
                a = key(m.group(1))
                b = key(m.group(2))
                digraphs.add((a, b))
                dec = int(m.group(3), 16)
                uni = unimap[dec]
                val = f'"{chr(dec)}"'
                desc = f'# {uni[0]} : {uni[1]}'
                if dec == 92:
                    val = r'"\\"'
                elif uni[2] == 'Cc':
                    if uni[10]:
                        desc += f' {uni[10]}'
                    val = rf'"\x{uni[0][2:]}"'
                a_ = f'<{a}>'
                b_ = f'<{b}>'
                of.write(f'<Multi_key> {a_:>14} {b_:14} : {val:6} {desc}\n')

compose_file = '/usr/share/X11/locale/en_US.UTF-8/Compose'

header = f'''\
# vim: ft=xcompose

# {compose_file}
# - tri+graphs hiding Vim digraphs are commented out starting with ###
#
# Generated by:
#
#   https://github.com/mkoskar/xcompose-vim
#   > {timestamp}

'''

with open(compose_file, 'r') as f, \
     open('.XCompose-en', 'w') as of:
    of.write(header)
    for line in f:
        if m := re.match(r'^<Multi_key>\s*<(\w+)>\s*<(\w+)>\s*<\w+>', line):
            if (m.group(1), m.group(2)) in digraphs:
                of.write('### ')
        of.write(line)
